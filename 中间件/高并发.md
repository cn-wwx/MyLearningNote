# 高并发

高并发指的是系统单位时间内请求量非常大，比如系统QPS大于10万。

 

高并发系统设计的目标：

高性能：系统处理请求的速度很快，响应时间短

高可用：系统几乎可以一直正常提供服务，也就是具备无故障运行的能力

可扩展：流量高峰时能否在短时间内完成扩容，更平稳地承接峰值流量

 

实现高性能的常用手段：

数据库：分库分表、读写分离

缓存

消息队列

负载均衡

池化技术

 

实现高可用的常用手段：

代码质量把关

限流

降级熔断

集群，减少单点故障

超时和重试机制

异步调用

 

实现可拓展架构的常用手段：

分层架构：面向流程拆分

微服务：面向服务拆分

微内核：面向功能拆分

 

## 单体架构到微服务架构演进

### 单体架构

单体架构：所有代码运行在一个进程内的程度；开发团队工作在一个代码库，任何项目成员对代码的改动都会影响到项目

![image-20220526170249208](../../AppData/Roaming/Typora/typora-user-images/image-20220526170249208.png)

优点：易测试、易部署；成本低；没有分布式架构问题；前中期开发快

缺点：容错能力差、技术栈被限定死、可伸缩性差、迭代速度慢、系统启动慢

 

### 垂直架构

以“业务“为维度对单体架构进行拆分

![image-20220526170304636](../../AppData/Roaming/Typora/typora-user-images/image-20220526170304636.png)

优点：提高并发，容错能力更强，技术栈灵活

缺点：数据冗余，代码冗余，强耦合

 

 

### SOA架构

面向服务的架构，就是将多个系统联系在一起，让他们像一个整体一样。“服务”在SOA架构中对应的就是各个独立运行的系统

![image-20220526170316228](../../AppData/Roaming/Typora/typora-user-images/image-20220526170316228.png)

优点：方便维护，复用服务，技术栈灵活

缺点：重量级通信方式ESB，包含了业务和消息处理逻辑，需要实现与各种系统间的协议转化、数据转化、透明地动态路由等功能。

 

### 微服务架构

是一种将单个系统拆分成一组微服务的架构风格。每个微服务运行在独立的线程下，它们之间通过轻量级通信机制进行通信。并且各个微服务可以使用不同的技术栈。

![image-20220526170326016](../../AppData/Roaming/Typora/typora-user-images/image-20220526170326016.png)

优点：各模块独立部署；可伸缩性好；技术栈灵活；迭代速度更快；

缺点：分布式系统固有问题（分布式事务、网络分区、跨服务调用）；成本高；运维要求高

 

 

 

 

## 负载均衡

概念：根据特定算法将用户的请求分摊到不同的服务器上处理，提高系统整体的并发处理能力

![image-20220526170335495](../../AppData/Roaming/Typora/typora-user-images/image-20220526170335495.png)

### 分类

服务端，客户端

 

#### 服务端负载均衡

主要应用在系统外部请求和网关层之间，可以通过硬件和软件实现

![image-20220526170352666](../../AppData/Roaming/Typora/typora-user-images/image-20220526170352666.png)

软件负载均衡：LVS、Nginx，根据OSI模型，负载均衡还可以分为：

二层负载均衡、七层负载均衡、三层负载均衡、四层负载均衡

![image-20220526170419217](../../AppData/Roaming/Typora/typora-user-images/image-20220526170419217.png)

 

#### 客户端负载均衡

![image-20220526170425221](../../AppData/Roaming/Typora/typora-user-images/image-20220526170425221.png)

![image-20220526170433826](../../AppData/Roaming/Typora/typora-user-images/image-20220526170433826.png)

 

### 负载均衡常见算法

随机法：简单粗暴；部分机器在一段时间内处于空闲状态

轮询法：轮询服务器处理，每个请求按时间顺序逐一分配到不同的服务器

一致性Hash：相同参数的请求总是发到同一台服务器处理

最小连接法：选取活动连接数最小的服务器来处理请求；可以尽可能最大地使请求分配更加合理，提供服务器利用率；实现复杂，需要监控每一台服务器处理的请求连接数

 

### 七层负载均衡常见方案

DNS解析、反向代理

![image-20220526170443166](../../AppData/Roaming/Typora/typora-user-images/image-20220526170443166.png)

 

![image-20220526170450890](../../AppData/Roaming/Typora/typora-user-images/image-20220526170450890.png)

 

### 客户端负载均衡常见方案

Netflix Ribbon Spirng Cloud Load Balancer

 

 

# 池化技术

概念：将可重复利用的对象比如连接、线程同一个管理起来的技术。线程池、数据库连接池、HTTP、Redis连接池等都是池化技术的应用。

 

核心思想：空间换时间

 

核心策略：使用已经创建好的对象来减少频繁创建销毁对象的性能开销，提升性能和资源复用。

 

## 线程池

JDK线程池——ThreadPoolExecutor有3个最重要的参数：

核心线程数，最大线程数，任务队列

工作原理：

![image-20220526170505424](../../AppData/Roaming/Typora/typora-user-images/image-20220526170505424.png)

 

 

Tomcat扩展了原生Java线程池，来满足Web容器高并发的需求：

Tomcat自定义线程池继承了JDK线程池，重写了部分方法的逻辑（主要是execute）。同时继承LinkedBlockingQueue重写offer方法实现了自定义的等待队列。

这些改变使得在任务量大的情况，会优先创建线程，而不是直接将任务放到队列中

 

 

## 数据库连接池

![image-20220526170514659](../../AppData/Roaming/Typora/typora-user-images/image-20220526170514659.png)



